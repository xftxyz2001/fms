# 实验五 -- 一个小型磁盘文件管理系统

> - 姓名：庞晓宇
> - 学号：2020118100


## 目的
1. 理解磁盘文件管理的概念和原理。
2. 了解文件的逻辑结构和物理结构；
3. 理解文件目录结构；
4. 掌握磁盘存储空间管理、文件操作实现方法。


## 内容
设计并实现一个简单的磁盘文件管理系统，用文件模拟磁盘，用数组模拟缓冲区，要求实现：
1. 支持多级目录结构，支持文件的绝对路径访问；
2. 文件的逻辑结构采用流式（字节流）结构，物理结构采用链式结构中的显式链方式；
3. 磁盘管理采用文件分配表；
4. 实现文件操作命令：创建目录、列表目录、删除空目录、创建文件、删除文件、显示文件内容、打开文件、读文件、写文件（追加方式）、关闭文件、改变文件属性；
5. 通过主函数对所实现的功能进行测试。

扩展
- 支持相对路径；支持文件COPY、移动和非空目录删除。

设计
1. 文件的组织结构
   - 文件的逻辑结构有流式和记录式两种形式，本项目只支持流式文件。
   - 显式链接的物理结构是把组成一个文件的每一块的指针组织在一起，形成一个文件分配表（FAT）。
2. 磁盘空间管理
   - 本项目用一个文件模拟一个小磁盘：128个盘块、每块64字节，块号0，1，2，3，。。。，127。
3. 文件分配表（FAT）
   - 磁盘有多少块，文件分配表就有多少项，磁盘块号与FAT表项序号一一对应。
   - 每项取值：若某文件的一个磁盘块号为i，则该文件的下一个磁盘块号应该存放在FAT的第i项，-1（255）表示文件结束；为0表示这是一个空闲块；可以用一个非0、非-1、非有效块号的值（如254）表示一个故障盘块。
   - 分配时查找值为0的项（设置一个“空闲块总数”变量可以提高分配下率!），并建立链表；回收时只需修改要回收的盘块对应表项的值。
   - 假定系统区（引导区、文件分配表、根目录等）占用的磁盘起始的若干盘块（比如3块，如下0、1、2块）。
        | 第几项 | 0   | 1   | 2   | 3   | 4   | 5   | 6   | 7   | 8   | 9   | 10  | 11  | 12  | 13  | 14  | 15  | 16  | ... |
        | ------ | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
        | 值     | -1  | -1  | -1  | 4   | 9   | 0   | 7   | 8   | -1  | 12  | 11  | -1  | 13  | -1  | 0   | 0   | 254 | ... |
    （如上，3个文件分别放在(3->4->9->12->13)、(6->7->8)和(10->11)中，5、14、15…是空闲块，块16故障）
4. 目录结构
   - 文件目录用于文件检索。
   - 目录项：文件目录由若干目录项组成，每一项有8字节大小，记录一个文件的有关信息，包括：文件名（3字节）、文件类型（2字节）、文件属性（1字节）、起始盘块号（1字节）、文件长度（1字节，盘块数）。
   - 目录结构：树型目录。目录也以文件形式存放在磁盘。根目录存放在磁盘1号块，子目录所在盘块号登记在根目录相应目录项中。本项目中，目录（根和子）的长度固定—8个目录项。一个目录项究竟对应的 是一个文件还是一个子目录，由“文件属性”指明。
    
    文件属性（1字节）：
    | 第7位  | 第6位  | 第5位  | 第4位  | 第3位    | 第2位    | 第1位    | 第0位    |
    | ------ | ------ | ------ | ------ | -------- | -------- | -------- | -------- |
    | 未使用 | 未使用 | 未使用 | 未使用 | 目录文件 | 普通文件 | 系统文件 | 只读文件 |

5. 文件命名
   - 文件名3字节，仅可以使用字母、数字和除“$”、“.”、“/”以外的字符，第一字节的值为“$”时表示该目录为空目录，文件名与类型之间用“.”分隔，用“/”作为路径中目录间分隔符。

    文件检索（根据绝对路径名）
   - 读出根目录盘块用路径名中根目录后的目录名检索根目录中的目录项，检索完一块，再根据FAT找到下一块，再读入检索直到检索到名字一致的目录项或根目录项已查完若未找到，则检索失败，结束；若找到的是文件，结束；若找到的是目录，则从找到的目录项中取出目录的起始盘块号，读入此盘块，使用以上检索方法继续查找，直到找到该文件（或目录）或检索失败。
6. 文件操作
   - 创建文件（create_file）、打开文件(open_file)、关闭文件(close_file)、读文件(read_file)、写文件（write_file）、删除文件(delete_file)、显示文件内容(typefile) 、改变文件属性(change)、创建目录(md)、列表目录(dir)、删除空目录(rd) –用选择方式输入命令；
   - 用“已打开文件表”记录已打开或建立文件的相关信息：
        路径名|文件属性|起始块号|文件长度|操作类型|读指针（块号|偏移量）|写指针（块号|偏移量）


## 测试输出
- 建立一个文件，模拟磁盘；
- 初始化磁盘FAT和根目录初始为空目录项；
- 选择文件操作命令，输入有关参数，进行测试——输出相应数据结构内容。
